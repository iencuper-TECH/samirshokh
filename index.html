<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMIRSHOKH TEST</title>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        .container { width: 95%; max-width: 500px; padding: 20px 0; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 20px; }
        .grid-item { height: 35px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .grid-item.done { background: var(--success); color: white; }
        .grid-item.active { border: 2px solid var(--primary); }
        .option { display: block; width: 100%; padding: 15px; margin: 8px 0; background: #f9fafb; border: 2px solid #f3f4f6; border-radius: 12px; text-align: left; cursor: pointer; }
        .option.selected { background: var(--primary); color: white; }
        .dev-link { margin-top: 20px; display: block; color: #6366f1; text-decoration: none; font-size: 14px; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—à–∏–±–æ–∫ */
        .option.wrong { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        .option.correct-v { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .report-btn { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; text-decoration: underline; margin-top: 10px; }
        .report-btn:hover { color: #ef4444; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="card">
        <h2 style="color:var(--primary); margin:0;">SAMIRSHOKH TEST</h2>
        <p>–°–∏—Å—Ç–µ–º–∞ —ç–∫–∑–∞–º–µ–Ω–æ–≤</p>
        <input type="text" id="nameInput" placeholder="–í–∞—à–∞ –§–∞–º–∏–ª–∏—è –∏ –ò–º—è">
        <input type="tel" id="phoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (Login)">
        <select id="subjectSelect">
            <option value="latin">–õ–∞—Ç–∏–Ω—Å–∫–∏–π —è–∑—ã–∫</option>
            <option value="history">–ò—Å—Ç–æ—Ä–∏—è</option>
            <option value="anatomy">–ê–Ω–∞—Ç–æ–º–∏—è</option>
            <option value="medical">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è</option>
            <option value="chemistry">–•–∏–º–∏—è</option>
            <option value="biology">–ë–∏–æ–ª–æ–≥–∏—è</option>
            <option value="english">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫</option>
            <option value="uzbek">–£–∑–±–µ–∫—Å–∫–∏–π —è–∑—ã–∫</option>
            <option value="histology">–ì–∏—Å—Ç–æ–ª–æ–≥–∏—è</option>
            <option value="philosophy">–§–∏–ª–æ—Å–æ—Ñ–∏—è</option>
        </select>
        <button class="btn" id="startBtn" onclick="tryLogin()">–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω</button>
        <a href="https://t.me/dr_samirshokh" class="dev-link" target="_blank">üë®‚Äçüíª –ù–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</a>
    </div>

    <div id="quizScreen" class="card hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span id="timer" style="color:#ef4444; font-weight:bold; font-size:18px;">30:00</span>
            <span id="qCounter">1 / 30</span>
        </div>
        <div class="grid" id="qGrid"></div>
        <p id="qText" style="font-weight:bold; text-align:left; min-height:60px;"></p>
        <div id="optionsArea"></div>
        
        <button id="reportBtn" class="report-btn" onclick="reportError()">‚ö†Ô∏è –°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ</button>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="background:#94a3b8" onclick="prevQ()">–ù–∞–∑–∞–¥</button>
            <button class="btn" onclick="nextQ()">–î–∞–ª—å—à–µ</button>
        </div>
        <button id="finishBtn" class="btn" style="background:var(--success); margin-top:15px" onclick="finish()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>

    <div id="resultScreen" class="card hidden">
        <h2>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2>
        <h1 id="scoreDisplay" style="font-size:80px; color:var(--primary); margin:20px 0;">0</h1>
        <p>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é.</p>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#6366f1" onclick="reviewMode()">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—à–∏–±–∫–∏</button>
            <button class="btn" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    let questions = []; let answers = {}; let currentIdx = 0;
    let timeLeft = 30 * 60; let timerInterval; let currentUser = {}; 
    let isReviewMode = false;

    let deviceId = localStorage.getItem('device_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('device_id', deviceId);

    async function tryLogin() {
        const name = document.getElementById('nameInput').value.trim();
        const phone = document.getElementById('phoneInput').value.trim();
        const subj = document.getElementById('subjectSelect').value;
        const btn = document.getElementById('startBtn');

        if(!name || !phone) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è –∏ –ù–æ–º–µ—Ä!");
        
        btn.disabled = true;
        btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞...";

        try {
            const userRef = db.collection("users").doc(phone);
            const userDoc = await userRef.get();

            if (!userDoc.exists) {
                alert("–û–®–ò–ë–ö–ê: –í–∞—à–µ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö. –°–≤—è–∂–∏—Ç–µ—Å—å —Å @dr_samirshokh");
                btn.disabled = false; btn.innerText = "–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω";
                return;
            }

            const userData = userDoc.data();
            if(userData.deviceId && userData.deviceId !== deviceId) {
                alert("–û–®–ò–ë–ö–ê: –í—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!");
                btn.disabled = false; btn.innerText = "–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω";
                return;
            }

            await userRef.set({ name: name, deviceId: deviceId, lastLogin: new Date() }, { merge: true });
            currentUser = { name, phone, subject: subj };

            const snap = await db.collection("questions").where("subject", "==", subj).get();
            if(snap.empty) {
                alert("–í —ç—Ç–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ –µ—â–µ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤!");
                btn.disabled = false; btn.innerText = "–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω";
                return;
            }

            questions = [];
            snap.forEach(doc => questions.push(doc.data()));
            questions.sort(() => Math.random() - 0.5);
            questions = questions.slice(0, 30);

            questions.forEach(q => {
                let opts = q.options.map((opt, i) => ({ txt: opt, isCorrect: i === q.correct }));
                opts.sort(() => Math.random() - 0.5);
                q.shuffledOptions = opts;
            });

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            renderGrid();
            showQuestion(0);
            startTimer();
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message);
            btn.disabled = false; btn.innerText = "–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω";
        }
    }

    function renderGrid() {
        const grid = document.getElementById('qGrid'); grid.innerHTML = "";
        questions.forEach((_, i) => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.id = 'grid-'+i; d.innerText = i+1;
            d.onclick = () => showQuestion(i); grid.appendChild(d);
        });
    }

    function showQuestion(idx) {
        currentIdx = idx;
        const q = questions[idx];
        document.getElementById('qText').innerText = q.text;
        document.getElementById('qCounter').innerText = `${idx+1} / ${questions.length}`;
        const area = document.getElementById('optionsArea'); area.innerHTML = "";
        
        q.shuffledOptions.forEach((optObj, i) => {
            const b = document.createElement('button');
            b.className = 'option';
            b.innerText = optObj.txt;

            if (isReviewMode) {
                if (optObj.isCorrect) b.classList.add('correct-v'); 
                if (answers[idx] === i && !optObj.isCorrect) b.classList.add('wrong'); 
            } else {
                if (answers[idx] === i) b.classList.add('selected');
                b.onclick = () => { 
                    answers[idx] = i; 
                    document.getElementById('grid-'+idx).classList.add('done'); 
                    showQuestion(idx); 
                };
            }
            area.appendChild(b);
        });
        document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('active'));
        document.getElementById('grid-'+idx).classList.add('active');
    }

    function nextQ() { if(currentIdx < questions.length-1) showQuestion(currentIdx+1); }
    function prevQ() { if(currentIdx > 0) showQuestion(currentIdx-1); }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) finish();
        }, 1000);
    }

    async function finish() {
        if(!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?")) return;
        clearInterval(timerInterval);
        let score = 0;
        questions.forEach((q, i) => {
            if(answers[i] !== undefined && q.shuffledOptions[answers[i]].isCorrect) score++;
        });
        await db.collection("results").add({
            studentName: currentUser.name, phone: currentUser.phone,
            subject: currentUser.subject, score: score, total: questions.length, date: new Date()
        });
        document.getElementById('quizScreen').classList.add('hidden');
        document.getElementById('resultScreen').classList.remove('hidden');
        document.getElementById('scoreDisplay').innerText = score + " / " + questions.length;
    }

    // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò
    async function reportError() {
        const q = questions[currentIdx];
        const reason = prompt("–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ç–∞–∫ –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ?");
        if (!reason) return;

        await db.collection("reports").add({
            questionText: q.text,
            subject: currentUser.subject,
            reason: reason,
            student: currentUser.name,
            date: new Date()
        });
        alert("–°–ø–∞—Å–∏–±–æ! –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é.");
    }

    function reviewMode() {
        isReviewMode = true;
        document.getElementById('resultScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.remove('hidden');
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('reportBtn').style.display = 'none';
        showQuestion(0);
    }
</script>
</body>
</html>