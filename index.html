<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMIRSHOKH TEST</title>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        .container { width: 95%; max-width: 500px; padding: 20px 0; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
        /* Стили для теста */
        .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 20px; }
        .grid-item { height: 35px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .grid-item.done { background: var(--success); color: white; }
        .grid-item.active { border: 2px solid var(--primary); }
        .option { display: block; width: 100%; padding: 15px; margin: 8px 0; background: #f9fafb; border: 2px solid #f3f4f6; border-radius: 12px; text-align: left; cursor: pointer; }
        .option.selected { background: var(--primary); color: white; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="card">
        <h2 style="color:var(--primary); margin:0;">SAMIRSHOKH TEST</h2>
        <p>Система экзаменов</p>
        <input type="text" id="nameInput" placeholder="Ваша Фамилия и Имя">
        <input type="tel" id="phoneInput" placeholder="Номер телефона (Login)">
        <select id="subjectSelect">
            <option value="latin">Латинский язык</option>
            <option value="history">История</option>
            <option value="anatomy">Анатомия</option>
            </select>
        <button class="btn" onclick="tryLogin()">Начать экзамен</button>
    </div>

    <div id="quizScreen" class="card hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span id="timer" style="color:#ef4444; font-weight:bold; font-size:18px;">30:00</span>
            <span id="qCounter">1 / 64</span>
        </div>
        <div class="grid" id="qGrid"></div>
        <p id="qText" style="font-weight:bold; text-align:left; min-height:60px;"></p>
        <div id="optionsArea"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="background:#94a3b8" onclick="prevQ()">Nazad</button>
            <button class="btn" onclick="nextQ()">Dalshe</button>
        </div>
        <button class="btn" style="background:var(--success); margin-top:15px" onclick="finish()">Завершить тест</button>
    </div>

    <div id="resultScreen" class="card hidden">
        <h2>Ваш результат</h2>
        <h1 id="scoreDisplay" style="font-size:80px; color:var(--primary); margin:20px 0;">0</h1>
        <p>Результат отправлен преподавателю.</p>
        <button class="btn" onclick="location.reload()">Выйти</button>
    </div>
</div>

<script src="config.js"></script>
<script>
    let questions = [];
    let answers = {};
    let currentIdx = 0;
    let timeLeft = 30 * 60; // 30 минут
    let timerInterval;
    let currentUser = {}; 

    // Защита устройства
    let deviceId = localStorage.getItem('device_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('device_id', deviceId);

    async function tryLogin() {
        const name = document.getElementById('nameInput').value;
        const phone = document.getElementById('phoneInput').value;
        const subj = document.getElementById('subjectSelect').value;

        if(!name || !phone) return alert("Заполните Имя и Номер!");

        // Сохраняем пользователя или обновляем имя
        const userRef = db.collection("users").doc(phone);
        const userDoc = await userRef.get();

        if (userDoc.exists) {
            const data = userDoc.data();
            if(data.deviceId && data.deviceId !== deviceId) {
                return alert("Ошибка! Вход возможен только с вашего первого устройства.");
            }
        }
        
        // Записываем/Обновляем данные ученика
        await userRef.set({
            name: name,
            phone: phone,
            deviceId: deviceId,
            lastLogin: new Date()
        }, { merge: true });

        currentUser = { name, phone, subject: subj };

        // Загрузка вопросов
        questions = [];
        const snap = await db.collection("questions").where("subject", "==", subj).get();
        snap.forEach(doc => questions.push(doc.data()));

        if(questions.length === 0) return alert("Вопросов нет!");

        // Перемешиваем и берем 64
        questions.sort(() => Math.random() - 0.5);
        questions = questions.slice(0, 64);

        // Перемешиваем ответы внутри вопросов
        questions.forEach(q => {
            let opts = q.options.map((opt, i) => ({ txt: opt, isCorrect: i === q.correct }));
            opts.sort(() => Math.random() - 0.5); // Мешаем кнопки
            q.shuffledOptions = opts;
        });

        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.remove('hidden');
        renderGrid();
        showQuestion(0);
        startTimer();
    }

    function renderGrid() {
        const grid = document.getElementById('qGrid'); grid.innerHTML = "";
        questions.forEach((_, i) => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.id = 'grid-'+i; d.innerText = i+1;
            d.onclick = () => showQuestion(i); grid.appendChild(d);
        });
    }

    function showQuestion(idx) {
        currentIdx = idx;
        const q = questions[idx];
        document.getElementById('qText').innerText = q.text;
        document.getElementById('qCounter').innerText = `${idx+1} / ${questions.length}`;

        const area = document.getElementById('optionsArea'); area.innerHTML = "";
        q.shuffledOptions.forEach((optObj, i) => {
            const b = document.createElement('button');
            b.className = 'option' + (answers[idx] === i ? ' selected' : '');
            b.innerText = optObj.txt;
            b.onclick = () => { answers[idx] = i; document.getElementById('grid-'+idx).classList.add('done'); showQuestion(idx); };
            area.appendChild(b);
        });
        document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('active'));
        document.getElementById('grid-'+idx).classList.add('active');
    }

    function nextQ() { if(currentIdx < questions.length-1) showQuestion(currentIdx+1); }
    function prevQ() { if(currentIdx > 0) showQuestion(currentIdx-1); }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) finish();
        }, 1000);
    }

    async function finish() {
        if(!confirm("Завершить и отправить результат?")) return;
        clearInterval(timerInterval);
        
        let score = 0;
        questions.forEach((q, i) => {
            if(answers[i] !== undefined && q.shuffledOptions[answers[i]].isCorrect) score++;
        });

        // СОХРАНЕНИЕ РЕЗУЛЬТАТА В БАЗУ
        await db.collection("results").add({
            studentName: currentUser.name,
            phone: currentUser.phone,
            subject: currentUser.subject,
            score: score,
            total: questions.length,
            date: new Date()
        });

        document.getElementById('quizScreen').classList.add('hidden');
        document.getElementById('resultScreen').classList.remove('hidden');
        document.getElementById('scoreDisplay').innerText = score + " / " + questions.length;
    }
</script>
</body>
</html>